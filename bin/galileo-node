#!/bin/bash
################################################################################
# galileo-node - manages the execution of a Galileo Storage Node.
################################################################################

unset daemonize restart stop
class="galileo.dht.StorageNode"
logfile="$(whoami)-node.log"

print_usage() {
cat <<- EOM
Usage: $(basename ${0}) [-d] [-r] [-s]

Switches:
    -d daemonize the process
    -r restart Galileo node
    -s stop Galileo node
EOM
}

blocking_pkill() {
    pkill ${@} &> /dev/null
    if [[ $? -ne 0 ]]; then
        return 1
    fi

    while :; do
        pgrep ${@} &> /dev/null
        if [[ $? -ne 0 ]]; then
            return 0
        else
            sleep 1
        fi
    done
}

source "$( cd "$( dirname "$0" )" && pwd )/galileo-environment"

while getopts "drs" flag; do
    case ${flag} in
        d) daemonize=true ;;
        r) restart=true ;;
        s) stop=true ;;
        ?) print_usage; exit 1 ;;
    esac
done

if [[ ${stop} == true || ${restart} == true ]]; then
    blocking_pkill -U $(whoami) -f ${class}

    if [[ ${stop} == true ]]; then
        exit 0
    fi
fi

if [[ ${daemonize} == true ]]; then
    logdir="/tmp/"
    if [[ -n ${GALILEO_ROOT} ]]; then
        logdir="${GALILEO_ROOT}"
    fi
    logpath="${logdir}/${logfile}"
    java -cp "${GALILEO_HOME}"/lib/\* ${class} &> "${logpath}" &
    pid=${!}

    # Do a simple check to see if the daemon died right away.
    sleep 1
    ps ${pid} &> /dev/null
    if [[ $? -ne 0 ]]; then
        echo "Error: failed to launch Galileo daemon on $(hostname)." 1>&2
        echo "See ${logpath} for details." 1>&2
    fi
else
    java -cp "${GALILEO_HOME}"/lib/\* ${class}
fi
