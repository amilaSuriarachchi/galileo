#!/bin/bash
################################################################################
# galileo-node - manages the execution of a Galileo Storage Node.
################################################################################

unset daemonize restart statuspath stop
class="galileo.dht.StorageNode"
logfile="$(whoami)-node.log"
statusfile="status.txt"

print_usage() {
cat <<- EOM
Usage: $(basename ${0}) [-d] [-r] [-s]

Switches:
    -d daemonize the process
    -r restart Galileo node
    -s stop Galileo node
EOM
}

print_status() {
    echo "[$(hostname)] ${@}"
}

blocking_pkill() {
    pkill ${@} &> /dev/null
    if [[ $? -ne 0 ]]; then
        return 1
    fi

    while :; do
        pgrep ${@} &> /dev/null
        if [[ $? -ne 0 ]]; then
            return 0
        else
            sleep 1
        fi
    done
}

source "$( cd "$( dirname "$0" )" && pwd )/galileo-environment"

while getopts "drs" flag; do
    case ${flag} in
        d) daemonize=true ;;
        r) restart=true ;;
        s) stop=true ;;
        ?) print_usage; exit 1 ;;
    esac
done

if [[ ${stop} == true || ${restart} == true ]]; then
    blocking_pkill -U $(whoami) -f ${class}

    if [[ ${stop} == true ]]; then
        print_status "Offline"
        exit 0
    else
        print_status "Restarting"
    fi
fi

if [[ ${daemonize} == true ]]; then
    logdir="${TMPDIR:-/tmp}"
    if [[ -n ${GALILEO_ROOT} && -w ${GALILEO_ROOT} ]]; then
        logdir="${GALILEO_ROOT}"
        statuspath="${GALILEO_ROOT}/${statusfile}"
    fi

    logpath="${logdir}/${logfile}"

    java -cp "${GALILEO_HOME}"/lib/\* ${class} &> "${logpath}" &
    pid=${!}

    sleep 2
    if [[ -n "${statuspath}" && -e "${statuspath}" ]]; then
        read status < "${statuspath}"
        print_status "${status}"
    else
        # Do a simple check to see if the daemon died right away.
        ps ${pid} &> /dev/null
        if [[ $? -ne 0 ]]; then
            print_status "FAILED"
        else
            print_status "UNKNOWN"
        fi
    fi
else
    java -cp "${GALILEO_HOME}"/lib/\* ${class}
fi
